

/* web/extensions/ext.min.js */
var extint={ws:null,param:null,displayed:!1,help_displayed:!1,current_ext_name:null,using_data_container:!1,default_w:525,default_h:300,prev_mode:null,seq:0},devl={in1:1,in2:0,in3:0};function ext_switch_to_client(t,e,n){recv_websocket(extint.ws,n),ext_send("SET ext_switch_to_client="+t+" first_time="+(e?1:0)+" rx_chan="+rx_chan),w3_call(t+"_focus")}function ext_send(t,e){null==e&&(e=extint.ws);try{return e.send(t),0}catch(t){console.log("CATCH ext_send('"+s+"') ex="+t),kiwi_trace()}}function ext_panel_show(t,e,n){extint_panel_show(t,e,n)}function ext_set_data_height(t){var e=w3_el("id-ext-data-container");t?e&&(e.style.height=px(t)):e&&(e.style.height="")}function ext_set_controls_width_height(t,e){panel_set_width_height("ext-controls",t,e)}var EXT_SAVE=!0,EXT_NO_SAVE=!1;function ext_get_cfg_param(t,e,n){var _;t=w3_add_toplevel(t);try{_=getVarFromString(t)}catch(t){_=null}return null!=_&&null!=_||null==e||(_=e,setVarFromString(t,_),null!=n&&n!=EXT_SAVE||cfg_save_json(t,extint.ws)),_}function ext_get_cfg_param_string(t,e,n){return decodeURIComponent(ext_get_cfg_param(t,e,n))}function ext_set_cfg_param(t,e,n){t=w3_add_toplevel(t),setVarFromString(t,e),null!=n&&n==EXT_SAVE&&cfg_save_json(t,extint.ws)}function ext_get_freq_range(){var t=cfg.freq_offset;return{lo_kHz:cfg.sdr_hu_lo_kHz+t,hi_kHz:cfg.sdr_hu_hi_kHz+t,offset_kHz:t}}var extint_isAdmin_cb,extint_authkey_cb,ext_zoom={TO_BAND:0,IN:1,OUT:-1,ABS:2,WHEEL:3,NOM_IN:8,MAX_IN:9,MAX_OUT:-9},extint_ext_is_tuning=!1;function ext_tune(t,e,n,_,i,o){extint_ext_is_tuning=!0,freqmode_set_dsp_kHz(t,e),null!=i&&null!=o&&ext_set_passband(i,o),null!=n?zoom_step(n,_):zoom_step(ext_zoom.TO_BAND),extint_ext_is_tuning=!1}function ext_get_freq_Hz(){return{displayed:freq_displayed_Hz,carrier:freq_car_Hz,passband_center:freq_passband_center()}}function ext_get_freq(){return freq_displayed_Hz}function ext_get_freq_kHz(){return(freq_displayed_Hz/1e3).toFixed(2)}function ext_get_carrier_freq(){return freq_car_Hz}function ext_get_passband_center_freq(){return freq_passband_center()}function ext_get_mode(){return cur_mode}function ext_get_prev_mode(){return extint.prev_mode}function ext_set_mode(t,e,n){var _="drm"==t;_&&(extint.prev_mode=cur_mode),demodulator_analog_replace(t,e);var i=w3_opt(n,"open_ext",!1),o=w3_opt(n,"no_drm_proc",!1),a="undefined"!=typeof drm&&drm.active;console.log("$ new_drm="+_+" open_ext="+i),o||(_&&i?a?toggle_panel("ext-controls",1):extint_open("drm"):!_&&a&&(extint_panel_hide(),demodulator_analog_replace(t,e)))}function ext_get_passband(){var t=demodulators[0];return{low:t.low_cut,high:t.high_cut}}function ext_set_passband(t,e,n,_){var i=demodulators[0],o=i.filter;null==t&&(t=i.low_cut),null==e&&(e=i.high_cut);Math.abs(e-t);t=t<o.low_cut_limit?o.low_cut_limit:t,e=e>o.high_cut_limit?o.high_cut_limit:e;var a=!1;Math.abs(e-t)>=o.min_passband&&t<e&&(i.low_cut=t,i.high_cut=e,a=!0),null!=n&&n&&a&&(passbands[cur_mode].last_lo=t,passbands[cur_mode].last_hi=e),null!=_&&null!=_&&(_*=1e3,freq_car_Hz=freq_dsp_to_car(_)),extint_ext_is_tuning=!0,demodulator_set_offset_frequency(0,freq_car_Hz-center_freq),extint_ext_is_tuning=!1}function ext_get_tuning(){return{low:demod.low_cut,high:demod.high_cut,mode:cur_mode,freq_dial_kHz:freq_displayed_Hz/1e3}}function ext_get_zoom(){return zoom_level}function ext_get_optbar(){return readCookie("last_optbar")}function ext_set_optbar(t){extint.optbars[t]&&(writeCookie("last_optbar",t),w3_el("id-nav-"+t).click())}function ext_hasCredential(t,e,n,_){var i;"mfg"==t&&(t="admin"),"admin"==t?(deleteCookie("admin"),deleteCookie("admin-pwd"),i=""):i=(i=readCookie(t))?decodeURIComponent(i):"",extint_pwd_cb=e,extint_pwd_cb_param=n,ext_valpwd(t,i,_)}function ext_valpwd(t,e,n){e=encodeURIComponent(e),"admin"!=t&&writeCookie(t,e),extint_conn_type=t,e=""!=e?e:"#";var _=null,i=readCookie("iplimit"),o=kiwi_url_param(["pwd","password"],"","");""!=o?_=o:i&&""!=i&&(_=i),_=_?" ipl="+_:"",null!=kiwi_url_param(["p","prot","protected"],"true",null)&&"admin"!=t&&(t="prot"),ext_send("SET auth t="+t+" p="+e+_,n)}function ext_isAdmin(t){extint_isAdmin_cb=t,ext_send("SET is_admin")}function ext_get_authkey(t){ext_send("SET get_authkey"),extint_authkey_cb=t}extint.optbars={"optbar-wf":0,"optbar-audio":1,"optbar-agc":2,"optbar-users":3,"optbar-status":4,"optbar-off":5};var extint_adc_clock_Hz=0;function ext_adc_clock_Hz(){return extint_adc_clock_Hz}var extint_adc_gps_clock_corr=0;function ext_adc_gps_clock_corr(){return extint_adc_gps_clock_corr}var extint_adc_clock_nom_Hz=0;function ext_adc_clock_nom_Hz(){return extint_adc_clock_nom_Hz}var extint_srate=0;function ext_sample_rate(){return extint_srate}var extint_audio_data_cb=null;function ext_register_audio_data_cb(t){extint_audio_data_cb=t}function ext_unregister_audio_data_cb(){extint_audio_data_cb=null}function ext_param(){var t=extint.param;return extint.param=null,t}function ext_panel_set_name(t){extint.current_ext_name=t}function ext_mobile_info(t){var e=window.innerWidth,n=window.innerHeight,_={width:e,height:n};_.wh_unchanged=t&&t.width==e&&t.height==n?1:0;var i=e<n||mobile_laptop_test?1:0;return _.orient_unchanged=t&&t.isPortrait==i?1:0,_.isPortrait=i?1:0,_.iPad=i&&e<=768?1:0,_.small=i&&e<768?1:0,_.narrow=i&&n<=600?1:0,_}function extint_news(t){var e=w3_el("id-news");e.style.width="200px",e.style.height="60px",e.style.visibility="visible",e.style.zIndex=9999,w3_innerHTML("id-news-inner",t)}function ext_panel_init(){w3_el("id-panels-container").innerHTML+='<div id="id-ext-controls" class="class-panel" data-panel-name="ext-controls" data-panel-pos="bottom-left" data-panel-order="0" data-panel-size="'+extint.default_w+","+extint.default_h+'"></div>';var t=w3_el("id-ext-data-container");t.style.zIndex=100,(t=w3_el("id-ext-controls")).innerHTML=w3_div("id-ext-controls-container w3-relative|width:100%;height:100%;")+w3_div("id-ext-controls-vis class-vis")+w3_div("id-ext-controls-help cl-ext-help",w3_button('id-ext-controls-help-btn w3-green w3-small w3-padding-small w3-disabled||onclick="extint_help_click()"',"help")),w3_el("id-kiwi-body").addEventListener("keyup",function(t){"Escape"==t.key&&extint.displayed&&!confirmation.displayed&&w3_el("id-ext-controls-close").click()},!0)}function extint_panel_show(t,e,n){var _;extint.using_data_container=!!e,extint.using_data_container?(toggle_or_set_spec(toggle_e.SET,0),w3_hide("id-top-container"),w3_show_block(w3_innerHTML("id-ext-data-container",e))):(w3_hide("id-ext-data-container"),spectrum_display||w3_show_block("id-top-container")),1==extint.help_displayed&&(confirmation_panel_close(),extint.help_displayed=!1),(_=w3_el("id-ext-controls-close")).onclick=function(){toggle_panel("ext-controls"),extint_panel_hide()},w3_el("id-ext-controls").style.zIndex=150,w3_attribute("id-ext-controls-close-img","src","icons/close.24.png"),(_=w3_el("id-ext-controls-container")).innerHTML=t,n&&n(),(_=w3_el("id-ext-controls")).style.zIndex=150,w3_visible(_,!0),_.panelShown=1,toggle_or_set_hide_panels(0),w3_el("id-confirmation-container").style.height="";var i=w3_call(extint.current_ext_name+"_help",!1);w3_set_props("id-ext-controls-help-btn","w3-disabled",isUndefined(i)||0==i),"off"==i&&w3_hide("id-ext-controls-help-btn"),extint.displayed=!0}function extint_panel_hide(){extint.using_data_container&&(w3_hide("id-ext-data-container"),w3_show_block("id-top-container"),extint.using_data_container=!1,1==extint.help_displayed&&(confirmation_panel_close(),extint.help_displayed=!1)),w3_visible("id-ext-controls",!1),extint_blur_prev(),w3_select_value("select-ext",-1),resize_waterfall_container(!0),freqset_select(),extint.displayed=!1}function extint_help_click(){w3_contains("id-ext-controls-help-btn","w3-disabled")||(console.log(extint.current_ext_name+"_help_click CLICKED"),extint.help_displayed=w3_call(extint.current_ext_name+"_help",!0))}function extint_environment_changed(t){setTimeout(function(){extint.current_ext_name&&w3_call(extint.current_ext_name+"_environment_changed",t),w3_call("injection_environment_changed",t)},100)}var extint_pwd_cb=null,extint_pwd_cb_param=null,extint_conn_type=null;function extint_valpwd_cb(t){extint_pwd_cb&&extint_pwd_cb(t,extint_pwd_cb_param)}function extint_open_ws_cb(){ext_hasCredential("kiwi",null,null),setTimeout(function(){setInterval(function(){ext_send("SET keepalive")},5e3)},5e3)}function extint_connect_server(){return extint.ws=open_websocket("EXT",extint_open_ws_cb,null,extint_msg_cb),extint.ws}function extint_msg_cb(t,e){switch(t[0]){case"keepalive":break;case"ext_client_init":console.log("ext_client_init is_locked="+ +t[1]),extint_focus(+t[1]);break;default:return!1}return!0}function extint_blur_prev(){null!=extint.current_ext_name&&(w3_call(extint.current_ext_name+"_blur"),recv_websocket(extint.ws,null),ext_set_controls_width_height(),extint.current_ext_name=null,time_display_setup("id-topbar-right-container")),extint.ws&&ext_send("SET ext_blur="+rx_chan)}function extint_focus(t){var e=extint.current_ext_name;if(console.log("extint_focus: loading "+e+".js"),t)return extint_panel_show(w3_text("w3-medium w3-text-css-yellow","Cannot use extensions while <br> another channel is in DRM mode.")),void ext_set_controls_width_height(450,75);kiwi_load_js_dir("extensions/"+e+"/"+e,[".js",".css"],function(){console.log("extint_focus: calling "+e+"_main()"),ext_set_controls_width_height(),w3_call(e+"_main")},function(t){if(console.log("extint_focus: "+e+" loaded="+t),t){extint_panel_show("loading extension..."),ext_set_controls_width_height(325,45),kiwi.is_locked&&console.log("==== IS_LOCKED =================================================")}})}var extint_names,extint_first_ext_load=!0;function extint_select(t){extint_blur_prev(),t=+t,w3_el("select-ext").value=t,extint.current_ext_name=extint_names[t],extint_first_ext_load?(extint.ws=extint_connect_server(),extint_first_ext_load=!1):ext_send("SET ext_is_locked_status")}function extint_list_json(t){extint_names=JSON.parse(decodeURIComponent(t))}function extint_select_menu(){var t="";if(extint_names&&isArray(extint_names))for(var e=0;e<extint_names.length;e++){var n=extint_names[e];if((dbgUs||"sig_gen"!=n)&&((dbgUs||"devl"!=n)&&(dbgUs||"s4285"!=n)&&(dbgUs||"colormap"!=n))){"wspr"==n&&(n="WSPR");var _=ext_get_cfg_param(n+".enable");(null==_||kiwi.is_local[rx_chan])&&(_=!0),"DRM"==n&&(kiwi.DRM_enable=_),t+='<option value="'+e+'" '+(_?"":"disabled")+">"+n+"</option>"}}return t}function extint_open(t,e){t=t.toLowerCase();for(var n=0;n<extint_names.length;n++){var _=extint_names[n];"wspr"==_&&(_="WSPR");var i=ext_get_cfg_param(_+".enable");if((null==i||kiwi.is_local[rx_chan])&&(i=!0),i&&_.toLowerCase().includes(t)){e?setTimeout(function(){extint_select(n)},e):extint_select(n);break}}}function extint_audio_data(t,e){isFunction(extint_audio_data_cb)&&extint_audio_data_cb(t,e)}